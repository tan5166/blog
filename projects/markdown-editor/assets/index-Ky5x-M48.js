import{$ as Z,n as gt,p as ht,T as et,h as J,H as Q}from"./index-Bb3spWYg.js";import{t as dt,T as vt}from"./index-qrz66fZu.js";import{r as E,c as ft,d as kt,h as k,e as Ot,b as Et,p as _t}from"./purify.es-CuyYui_p.js";var Lt=Object.defineProperty,it=Object.getOwnPropertySymbols,Tt=Object.prototype.hasOwnProperty,Mt=Object.prototype.propertyIsEnumerable,ot=(e,t,i)=>t in e?Lt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Ct=(e,t)=>{for(var i in t||(t={}))Tt.call(t,i)&&ot(e,i,t[i]);if(it)for(var i of it(t))Mt.call(t,i)&&ot(e,i,t[i]);return e};function L(e,t){return Object.assign(e,{meta:Ct({package:"@milkdown/components"},t)}),e}var $t=Object.defineProperty,rt=Object.getOwnPropertySymbols,St=Object.prototype.hasOwnProperty,Wt=Object.prototype.propertyIsEnumerable,nt=(e,t,i)=>t in e?$t(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,tt=(e,t)=>{for(var i in t||(t={}))St.call(t,i)&&nt(e,i,t[i]);if(rt)for(var i of rt(t))Wt.call(t,i)&&nt(e,i,t[i]);return e};const It={mode:"preview"},_=Z(tt({},It),"linkTooltipStateCtx");L(_,{displayName:"State<link-tooltip>",group:"LinkTooltip"});const xt={addLink:()=>{},editLink:()=>{},removeLink:()=>{}},G=Z(tt({},xt),"linkTooltipAPICtx");L(_,{displayName:"API<link-tooltip>",group:"LinkTooltip"});const Dt={linkIcon:()=>"🔗",editButton:()=>"✎",removeButton:()=>"⌫",confirmButton:()=>"Confirm ⏎",onCopyLink:()=>{},inputPlaceholder:"Paste link..."},N=Z(tt({},Dt),"linkTooltipConfigCtx");L(_,{displayName:"Config<link-tooltip>",group:"LinkTooltip"});const q=dt("LINK_PREVIEW");L(q[0],{displayName:"PreviewTooltipSpec<link-tooltip>",group:"LinkTooltip"});L(q[1],{displayName:"PreviewTooltipPlugin<link-tooltip>",group:"LinkTooltip"});const X=dt("LINK_EDIT");L(X[0],{displayName:"EditTooltipSpec<link-tooltip>",group:"LinkTooltip"});L(X[1],{displayName:"EditTooltipPlugin<link-tooltip>",group:"LinkTooltip"});function b({icon:e,class:t,onClick:i}){return k("span",{class:Et("milkdown-icon",t),onPointerdown:i,ref:s=>{s&&e&&(s.innerHTML=_t.sanitize(e.trim()))}})}b.props={icon:{type:String,required:!1},class:{type:String,required:!1},onClick:{type:Function,required:!1}};const bt=kt({props:{config:{type:Object,required:!0},src:{type:Object,required:!0},onConfirm:{type:Function,required:!0},onCancel:{type:Function,required:!0}},setup({config:e,src:t,onConfirm:i,onCancel:s}){const l=E(t);Ot(t,r=>{l.value=r});const o=()=>{i(l.value)},a=r=>{r.stopPropagation(),r.key==="Enter"&&(r.preventDefault(),o()),r.key==="Escape"&&(r.preventDefault(),s())};return()=>k("div",{class:"link-edit"},k("input",{class:"input-area",placeholder:e.value.inputPlaceholder,onKeydown:a,onInput:r=>{l.value=r.target.value},value:l.value}),l.value?k(b,{class:"button confirm",icon:e.value.confirmButton(),onClick:o}):null)}});var Nt=Object.defineProperty,qt=Object.defineProperties,At=Object.getOwnPropertyDescriptors,st=Object.getOwnPropertySymbols,Bt=Object.prototype.hasOwnProperty,jt=Object.prototype.propertyIsEnumerable,mt=e=>{throw TypeError(e)},at=(e,t,i)=>t in e?Nt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,A=(e,t)=>{for(var i in t||(t={}))Bt.call(t,i)&&at(e,i,t[i]);if(st)for(var i of st(t))jt.call(t,i)&&at(e,i,t[i]);return e},lt=(e,t)=>qt(e,At(t)),wt=(e,t,i)=>t.has(e)||mt("Cannot "+i),p=(e,t,i)=>(wt(e,t,"read from private field"),i?i.call(e):t.get(e)),f=(e,t,i)=>t.has(e)?mt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),y=(e,t,i,s)=>(wt(e,t,"write to private field"),t.set(e,i),i),C,m,w,B,$,j,g,U,F;const pt={from:-1,to:-1,mark:null};class Ft{constructor(t,i){this.ctx=t,f(this,C),f(this,m),f(this,w,A({},pt)),f(this,B),f(this,$),f(this,j,E("")),f(this,g,()=>{p(this,m).hide(),this.ctx.update(_.key,o=>lt(A({},o),{mode:"preview"})),y(this,w,A({},pt))}),f(this,U,o=>{const a=this.ctx.get(J),{from:r,to:c,mark:u}=p(this,w),v=Q.type(this.ctx),M=_t.sanitize(o);if(u&&u.attrs.href===M){p(this,g).call(this);return}const T=a.state.tr;u&&T.removeMark(r,c,u),T.addMark(r,c,v.create({href:M})),a.dispatch(T),p(this,g).call(this)}),f(this,F,(o,a,r)=>{const c=this.ctx.get(N.key);p(this,$).value=c,p(this,j).value=o,this.ctx.update(_.key,v=>lt(A({},v),{mode:"edit"}));const u=this.ctx.get(J);u.dispatch(u.state.tr.setSelection(et.create(u.state.doc,a,r))),p(this,m).show({getBoundingClientRect:()=>ht(u,a,r)}),requestAnimationFrame(()=>{var v;(v=p(this,C).querySelector("input"))==null||v.focus()})}),this.update=o=>{const{state:a}=o,{selection:r}=a;if(!(r instanceof et))return;const{from:c,to:u}=r;c===p(this,w).from&&u===p(this,w).to||p(this,g).call(this)},this.destroy=()=>{p(this,B).unmount(),p(this,m).destroy(),p(this,C).remove()},this.addLink=(o,a)=>{y(this,w,{from:o,to:a,mark:null}),p(this,F).call(this,"",o,a)},this.editLink=(o,a,r)=>{y(this,w,{from:a,to:r,mark:o}),p(this,F).call(this,o.attrs.href,a,r)},this.removeLink=(o,a)=>{const r=this.ctx.get(J),c=r.state.tr;c.removeMark(o,a,Q.type(this.ctx)),r.dispatch(c),p(this,g).call(this)},y(this,$,E(this.ctx.get(N.key)));const s=document.createElement("div");s.className="milkdown-link-edit";const l=ft(bt,{config:p(this,$),src:p(this,j),onConfirm:p(this,U),onCancel:p(this,g)});l.mount(s),y(this,B,l),y(this,C,s),y(this,m,new vt({content:s,debounce:0,shouldShow:()=>!1})),p(this,m).onHide=()=>{requestAnimationFrame(()=>{i.dom.focus({preventScroll:!0})})},p(this,m).update(i)}}C=new WeakMap;m=new WeakMap;w=new WeakMap;B=new WeakMap;$=new WeakMap;j=new WeakMap;g=new WeakMap;U=new WeakMap;F=new WeakMap;var Rt=Object.defineProperty,Vt=Object.defineProperties,Ht=Object.getOwnPropertyDescriptors,ct=Object.getOwnPropertySymbols,Kt=Object.prototype.hasOwnProperty,Yt=Object.prototype.propertyIsEnumerable,ut=(e,t,i)=>t in e?Rt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,zt=(e,t)=>{for(var i in t||(t={}))Kt.call(t,i)&&ut(e,i,t[i]);if(ct)for(var i of ct(t))Yt.call(t,i)&&ut(e,i,t[i]);return e},Gt=(e,t)=>Vt(e,Ht(t));function Xt(e){let t;e.update(G.key,i=>Gt(zt({},i),{addLink:(s,l)=>{t==null||t.addLink(s,l)},editLink:(s,l,o)=>{t==null||t.editLink(s,l,o)},removeLink:(s,l)=>{t==null||t.removeLink(s,l)}})),e.set(X.key,{view:i=>(t=new Ft(e,i),t)})}function Jt(e,t,i,s,l){let o={start:-1,end:-1};return i.nodesBetween(s,l,(a,r)=>{if(o.start>-1)return!1;o.start===-1&&e.isInSet(a.marks)&&t===a&&(o={start:r,end:r+Math.max(a.textContent.length,1)})}),o}function Qt(e,t,i){const s=t.posAtCoords({left:i.clientX,top:i.clientY});if(!s)return;const{pos:l}=s,o=t.state.doc.nodeAt(l);if(!o)return;const a=o.marks.find(c=>c.type===Q.mark.type(e));if(!(!a||!q.pluginKey()))return{show:!0,pos:l,node:o,mark:a}}const Ut=kt({props:{config:{type:Object,required:!0},src:{type:Object,required:!0},onEdit:{type:Object,required:!0},onRemove:{type:Object,required:!0}},setup({config:e,src:t,onEdit:i,onRemove:s}){const l=r=>{r.preventDefault(),r.stopPropagation(),i.value()},o=r=>{r.preventDefault(),r.stopPropagation(),s.value()},a=r=>{r.preventDefault();const c=t.value;navigator.clipboard&&c&&navigator.clipboard.writeText(c).then(()=>{e.value.onCopyLink(c)}).catch(u=>console.error(u))};return()=>k("div",{class:"link-preview",onPointerdown:a},k(b,{class:"link-icon",icon:e.value.linkIcon()}),k("a",{href:t.value,target:"_blank",class:"link-display"},t.value),k(b,{class:"button link-edit-button",icon:e.value.editButton(),onClick:l}),k(b,{class:"button link-remove-button",icon:e.value.removeButton(),onClick:o}))}});var yt=e=>{throw TypeError(e)},Pt=(e,t,i)=>t.has(e)||yt("Cannot "+i),n=(e,t,i)=>(Pt(e,t,"read from private field"),i?i.call(e):t.get(e)),h=(e,t,i)=>t.has(e)?yt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),P=(e,t,i,s)=>(Pt(e,t,"write to private field"),t.set(e,i),i),O,d,S,W,R,V,H,I,x,K,Y,z,D;class Zt{constructor(t,i){this.ctx=t,h(this,O),h(this,d),h(this,S,this.ctx.use(_.key)),h(this,W),h(this,R,E("")),h(this,V,E(()=>{})),h(this,H,E(()=>{})),h(this,I),h(this,x,!1),h(this,K,({mode:s})=>{s==="edit"&&n(this,D).call(this)}),h(this,Y,()=>{P(this,x,!0)}),h(this,z,()=>{P(this,x,!1)}),h(this,D,()=>{n(this,d).hide(),n(this,d).element.removeEventListener("mouseenter",n(this,Y)),n(this,d).element.removeEventListener("mouseleave",n(this,z))}),this.show=(s,l,o,a)=>{n(this,W).value=this.ctx.get(N.key),n(this,R).value=s.attrs.href,n(this,V).value=()=>{this.ctx.get(G.key).editLink(s,l,o)},n(this,H).value=()=>{this.ctx.get(G.key).removeLink(l,o),n(this,D).call(this)},n(this,d).show({getBoundingClientRect:()=>a}),n(this,d).element.addEventListener("mouseenter",n(this,Y)),n(this,d).element.addEventListener("mouseleave",n(this,z))},this.hide=()=>{n(this,x)||n(this,D).call(this)},this.update=()=>{},this.destroy=()=>{n(this,I).unmount(),n(this,S).off(n(this,K)),n(this,d).destroy(),n(this,O).remove()},P(this,W,E(this.ctx.get(N.key))),P(this,I,ft(Ut,{config:n(this,W),src:n(this,R),onEdit:n(this,V),onRemove:n(this,H)})),P(this,O,document.createElement("div")),n(this,O).className="milkdown-link-preview",n(this,I).mount(n(this,O)),P(this,d,new vt({debounce:0,content:n(this,O),shouldShow:()=>!1})),n(this,d).update(i),P(this,S,t.use(_.key)),n(this,S).on(n(this,K))}}O=new WeakMap;d=new WeakMap;S=new WeakMap;W=new WeakMap;R=new WeakMap;V=new WeakMap;H=new WeakMap;I=new WeakMap;x=new WeakMap;K=new WeakMap;Y=new WeakMap;z=new WeakMap;D=new WeakMap;function te(e){let t;const s=gt((o,a)=>{if(!t||!o.hasFocus()||e.get(_.key).mode==="edit")return;const c=Qt(e,o,a);if(c){const u=o.state.doc.resolve(c.pos),v=Jt(c.mark,c.node,o.state.doc,u.before(),u.after()),M=v.start,T=v.end;t.show(c.mark,M,T,ht(o,M,T));return}t.hide()},200),l=()=>{setTimeout(()=>{t==null||t.hide()},200)};e.set(q.key,{props:{handleDOMEvents:{mousemove:s,mouseleave:l}},view:o=>(t=new Zt(e,o),t)})}function re(e){te(e),Xt(e)}const ne=[_,G,N,q,X].flat();export{ne as a,G as b,re as c,N as l};
